"""
File contains functions used to train Linear Support Vector Machine.

Author: Dominik Macko
"""

from typing import Dict, Any, Union, Callable, Tuple

import numpy as np
import pandas as pd
from sklearn.svm import LinearSVC

from .generic import train_model, train_gridsearchcv_model

def linear_svm_best_params_surroundings(best_params: Dict[str, Any]) -> Dict[str, Any]:
    """Get best parameters surroundings for random forest."""
    
    C = best_params["C"]
    return {
        "C": [1/2 * C, C, 3/2 * C]
    }

def train_linear_svm(train_X: np.array,
                     train_y: np.array,
                     scoring: Union[str, Callable[[Any, np.array, np.array], int]]="f1_macro",
                     n_jobs: int=8,
                     verbose: int=3,
                     seed: int=42,
                     cv_splits: int=5,
                     ) -> Tuple[LinearSVC, pd.DataFrame]:
    """Trains linear support vector machine by searching for optimal l1 ratio.
    
    train_X - training set features
    train_y - training set targets
    scoring - scikit scoring function to use
    n_jobs - threads to use
    verbose - scikit verbose level
    seed - random seed to use
    
    returns (model, history dataframe)
    """
    
    grid = {
        "penalty": ["l1", "l2"],
        "loss": ["hinge", "squared_hinge"],
        "C": [0.001, 0.01, 0.1, 1.0, 10.0, 100.0]
    }
    return train_model(
        LinearSVC(
            dual=False,
            class_weight="balanced",
            random_state=seed,
            max_iter=1000
        ),
        train_gridsearchcv_model,
        train_gridsearchcv_model,
        grid,
        linear_svm_best_params_surroundings,
        train_X,
        train_y,
        scoring=scoring,
        n_jobs=n_jobs,
        verbose=verbose,
        cv_splits=cv_splits
    )
